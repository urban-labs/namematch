<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>namematch.block &mdash; namematch 0.0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> namematch
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About Name Match</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../match_setup.html">Setting Up a Match</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../understanding_results.html">Understanding Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../algorithm.html">Detailed Algorithm Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">namematch</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>namematch.block</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for namematch.block</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">editdistance</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>

<span class="c1"># suppress super-verbose nmslib logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;nmslib&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">nmslib</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">string</span>

<span class="kn">import</span> <span class="nn">pyarrow</span> <span class="k">as</span> <span class="nn">pa</span>
<span class="kn">import</span> <span class="nn">pyarrow.parquet</span> <span class="k">as</span> <span class="nn">pq</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">CountVectorizer</span>

<span class="kn">from</span> <span class="nn">namematch.data_structures.schema</span> <span class="kn">import</span> <span class="n">Schema</span>
<span class="kn">from</span> <span class="nn">namematch.data_structures.parameters</span> <span class="kn">import</span> <span class="n">Parameters</span>
<span class="kn">from</span> <span class="nn">namematch.base</span> <span class="kn">import</span> <span class="n">NamematchBase</span>
<span class="kn">from</span> <span class="nn">namematch.utils.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">log_runtime_and_memory</span><span class="p">,</span>
    <span class="n">get_nn_string_from_blockstring</span><span class="p">,</span>
    <span class="n">build_blockstring</span><span class="p">,</span>
    <span class="n">get_endpoints</span><span class="p">,</span>
    <span class="n">get_ed_string_from_blockstring</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">namematch.utils.profiler</span> <span class="kn">import</span> <span class="n">Profiler</span>

<span class="n">profile</span> <span class="o">=</span> <span class="n">Profiler</span><span class="p">()</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>

<div class="viewcode-block" id="Block"><a class="viewcode-back" href="../../api.html#namematch.block.Block">[docs]</a><span class="k">class</span> <span class="nc">Block</span><span class="p">(</span><span class="n">NamematchBase</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Args:</span>
<span class="sd">        params (Parameters object): contains matching parameter values</span>
<span class="sd">        schema (Schema object): contains match schema info (files to match, variables to use, etc.)</span>
<span class="sd">        all_names_file (str): path to the all-names file</span>
<span class="sd">        must_links_file (str): path to the must-links file</span>
<span class="sd">        blocking_index_bin_file: name of blocking index file</span>
<span class="sd">        og_blocking_index_file (str): path to a pre-built nmslib index (optional, if doesn&#39;t exist then None)</span>
<span class="sd">        candidate_pairs_file (str): path to the candidate-pairs file</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params</span><span class="p">,</span>
        <span class="n">schema</span><span class="p">,</span>
        <span class="n">all_names_file</span><span class="o">=</span><span class="s1">&#39;all_names.parquet&#39;</span><span class="p">,</span>
        <span class="n">must_links_file</span><span class="o">=</span><span class="s1">&#39;must_links.csv&#39;</span><span class="p">,</span>
        <span class="n">candidate_pairs_file</span><span class="o">=</span><span class="s1">&#39;candidate_pairs.parquet&#39;</span><span class="p">,</span>
        <span class="n">blocking_index_bin_file</span><span class="o">=</span><span class="s1">&#39;blocking_index.bin&#39;</span><span class="p">,</span>
        <span class="n">og_blocking_index_file</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Block</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">all_names_file</span> <span class="o">=</span> <span class="n">all_names_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">must_links_file</span> <span class="o">=</span> <span class="n">must_links_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">og_blocking_index_file</span> <span class="o">=</span> <span class="n">og_blocking_index_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_index_file</span> <span class="o">=</span> <span class="n">blocking_index_bin_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">candidate_pairs_file</span> <span class="o">=</span> <span class="n">candidate_pairs_file</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">output_files</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">candidate_pairs_file</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_index_file</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_index_file</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_index_file</span> <span class="o">+</span> <span class="s1">&#39;.dat&#39;</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">incremental</span><span class="p">:</span>
            <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">candidate_pairs_file</span><span class="p">)</span>
            <span class="n">output_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;uncovered_pairs.csv&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">output_files</span>

<div class="viewcode-block" id="Block.main"><a class="viewcode-back" href="../../api.html#namematch.block.Block.main">[docs]</a>    <span class="nd">@log_runtime_and_memory</span>
    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Generate the candidate-pairs list using the blocking scheme outlined in the config.&#39;&#39;&#39;</span>
        <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">candidate_pairs_file</span><span class="p">)</span>

        <span class="n">nn_cols</span><span class="p">,</span> <span class="n">ed_col</span><span class="p">,</span> <span class="n">absval_col</span> <span class="o">=</span> <span class="n">get_blocking_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">blocking_scheme</span><span class="p">)</span>

        <span class="c1"># check if the absval_col is needed -- if not, set to None</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_names_file</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;drop_from_nm&#39;</span><span class="p">,</span> <span class="n">ed_col</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">temp</span><span class="p">[</span><span class="n">temp</span><span class="o">.</span><span class="n">drop_from_nm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">][[</span><span class="n">ed_col</span><span class="p">]]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ed_col</span><span class="si">}</span><span class="s2"> == &#39;&#39; or </span><span class="si">{</span><span class="n">ed_col</span><span class="si">}</span><span class="s2">.isnull()&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">absval_col</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">an</span> <span class="o">=</span> <span class="n">read_an</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_names_file</span><span class="p">,</span> <span class="n">nn_cols</span><span class="p">,</span> <span class="n">ed_col</span><span class="p">,</span> <span class="n">absval_col</span><span class="p">)</span>

        <span class="n">nn_string_info</span><span class="p">,</span> <span class="n">nn_string_expanded_df</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">convert_all_names_to_blockstring_info</span><span class="p">(</span><span class="n">an</span><span class="p">,</span> <span class="n">absval_col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

        <span class="n">main_index</span><span class="p">,</span> \
        <span class="n">main_index_nn_strings</span><span class="p">,</span> \
        <span class="n">second_index</span><span class="p">,</span> \
        <span class="n">second_index_nn_strings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_indices</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                <span class="n">nn_string_info</span><span class="o">.</span><span class="n">nn_string</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">og_blocking_index_file</span><span class="p">)</span>

        <span class="c1"># only query names that appear in the new data</span>
        <span class="n">nn_string_info_to_query</span><span class="p">,</span> \
        <span class="n">nn_strings_to_query</span><span class="p">,</span> \
        <span class="n">shingles_to_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_query_strings</span><span class="p">(</span><span class="n">nn_string_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">blocking_scheme</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">candidate_pairs_file</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">candidate_pairs_file</span><span class="p">)</span>

        <span class="n">exact_match_cp_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_exact_match_candidate_pairs</span><span class="p">(</span>
                <span class="n">nn_string_info_to_query</span><span class="p">[</span><span class="n">nn_string_info_to_query</span><span class="o">.</span><span class="n">n_total</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">nn_string_expanded_df</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">blocking_thresholds</span><span class="p">)</span>
        <span class="n">write_some_cps</span><span class="p">(</span><span class="n">exact_match_cp_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">candidate_pairs_file</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">candidate_pairs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_candidate_pairs</span><span class="p">(</span>
            <span class="n">nn_strings_to_query</span><span class="p">,</span>
            <span class="n">shingles_to_query</span><span class="p">,</span>
            <span class="n">nn_string_info</span><span class="p">,</span>
            <span class="n">nn_string_expanded_df</span><span class="p">,</span>
            <span class="n">main_index</span><span class="p">,</span>
            <span class="n">main_index_nn_strings</span><span class="p">,</span>
            <span class="n">second_index</span><span class="p">,</span>
            <span class="n">second_index_nn_strings</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">block_batch_size</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># evaluate blocking</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">incremental</span><span class="p">:</span>
            <span class="n">must_links_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">must_links_file</span><span class="p">)</span>

            <span class="n">true_pairs_df</span> <span class="o">=</span> <span class="n">generate_true_pairs</span><span class="p">(</span><span class="n">must_links_df</span><span class="p">)</span>
            <span class="n">uncovered_pairs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_blocking</span><span class="p">(</span>
                    <span class="n">candidate_pairs_df</span><span class="p">,</span> <span class="n">true_pairs_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">blocking_scheme</span><span class="p">)</span>

            <span class="n">candidate_pairs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_uncovered_pairs</span><span class="p">(</span><span class="n">candidate_pairs_df</span><span class="p">,</span> <span class="n">uncovered_pairs_df</span><span class="p">)</span>

            <span class="n">uncovered_pairs_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span> <span class="c1"># only needed for each sanity check glance</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s1">&#39;uncovered_pairs.csv&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_NONNUMERIC</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

        <span class="c1"># output</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">candidate_pairs_df</span><span class="p">)</span>
        <span class="n">pq</span><span class="o">.</span><span class="n">write_table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">candidate_pairs_file</span><span class="p">)</span>

        <span class="n">save_main_index</span><span class="p">(</span><span class="n">main_index</span><span class="p">,</span> <span class="n">main_index_nn_strings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_index_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_lprof</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_line_profile_stats</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">line_profiler</span><span class="p">)</span></div>

<div class="viewcode-block" id="Block.split_last_names"><a class="viewcode-back" href="../../api.html#namematch.block.Block.split_last_names">[docs]</a>    <span class="nd">@log_runtime_and_memory</span>
    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">split_last_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">last_name_column</span><span class="p">,</span> <span class="n">blocking_scheme</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Expand the processed all-names file to handle double last names (e.g. SAM SMITH-BROWN</span>
<span class="sd">        becomes SAM SMITH and SAM BROWN).</span>

<span class="sd">        Args:</span>
<span class="sd">            df: all-names table, relevant columns only (where drop_from_nm == 0)</span>
<span class="sd">            last_name_column (str): clean last name column</span>
<span class="sd">            blocking_scheme (dict): dictionary with info on how to do blocking</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: more rows than input all names, plus orig_last_name and orig_record columns</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># preliminary cleaning</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;orig_last_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">last_name_column</span><span class="p">]</span>

        <span class="n">names_to_expand</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">last_name_column</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names_to_expand</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c1"># if there are multiple spaces, split on the last one</span>
            <span class="n">names_to_expand</span><span class="p">[</span><span class="s2">&quot;split_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">names_to_expand</span><span class="p">[</span><span class="n">last_name_column</span><span class="p">]</span><span class="o">.</span><span class="n">str</span>
                    <span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

            <span class="c1"># unpack the list of splits, so each is in its own row</span>
            <span class="n">id_vars</span> <span class="o">=</span> <span class="n">names_to_expand</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">id_vars</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;split_names&quot;</span><span class="p">)</span>
            <span class="n">split_up</span> <span class="o">=</span> <span class="p">(</span><span class="n">names_to_expand</span><span class="p">[</span><span class="s2">&quot;split_names&quot;</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">names_to_expand</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;split_names&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="n">id_vars</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;split_name&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span>

            <span class="n">split_up</span><span class="p">[</span><span class="n">last_name_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">split_up</span><span class="p">[</span><span class="s2">&quot;split_name&quot;</span><span class="p">]</span>
            <span class="n">split_up</span> <span class="o">=</span> <span class="n">split_up</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;split_name&quot;</span><span class="p">])</span>

            <span class="c1"># make sure the original name is there as well</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">split_up</span><span class="p">])</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;orig_record&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">last_name_column</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;orig_last_name&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;nn_string_full&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">nn_string</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;nn_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_blockstring</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">blocking_scheme</span><span class="p">,</span> <span class="n">incl_ed_string</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="Block.convert_all_names_to_blockstring_info"><a class="viewcode-back" href="../../api.html#namematch.block.Block.convert_all_names_to_blockstring_info">[docs]</a>    <span class="nd">@log_runtime_and_memory</span>
    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">convert_all_names_to_blockstring_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">an</span><span class="p">,</span> <span class="n">absval_col</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create a table with information about blockstrings. If the split_names parameter is True,</span>
<span class="sd">        then this function expands double last names to create two new &quot;records&quot; (e.g. SAM SMITH-BROWN</span>
<span class="sd">        becomes SAM SMITH and SAM BROWN).</span>

<span class="sd">        Args:</span>
<span class="sd">            an (pd.DataFrame): all-names table, relevant columns only (where drop_from_nm == 0)</span>

<span class="sd">                =======================  =======================================================</span>
<span class="sd">                record_id                unique record identifier</span>
<span class="sd">                blockstring              concatenation of all the blocking variables (sep by ::)</span>
<span class="sd">                file_type                either &quot;new&quot; or &quot;existing&quot;</span>
<span class="sd">                drop_from_nm             flag, 1 if met any &quot;to drop&quot; criteria 0 otherwise</span>
<span class="sd">                &lt;nn-blocking column(s)&gt;  variables for near-neighbor blocking</span>
<span class="sd">                &lt;ed-blocking column&gt;     variable for edit-distance blocking</span>
<span class="sd">                &lt;av-blocking column&gt;     (optional) variable for abs-value blocking</span>
<span class="sd">                nn_string                concatenated version of nn-blocking columns (sep by ::)</span>
<span class="sd">                ed_string                copy of ed-blocking column</span>
<span class="sd">                absval_string            copy of abs-value-blocking column</span>
<span class="sd">                =======================  =======================================================</span>

<span class="sd">            absval_col (str): column for absolute-value blocking</span>
<span class="sd">            params (Parameter object): contains matching parameters</span>

<span class="sd">        Returns:</span>
<span class="sd">                tuple: tuple containing:</span>

<span class="sd">                - **nn_string_info** (*pd.DataFrame*): table with one row per nn_string (or expanded nn_string)</span>

<span class="sd">                    ======================   ==============================================================</span>
<span class="sd">                    nn_string                concatenated version of nn-blocking columns (sep by ::)</span>
<span class="sd">                    commonness_penalty       float indicating how common the last name is</span>
<span class="sd">                    n_new                    number of times this nn_string appears in a &quot;new&quot; record</span>
<span class="sd">                    n_existing               number of times this nn_string appears in an &quot;existing&quot; record</span>
<span class="sd">                    n_total                  number of times this nn_string appears in any record</span>
<span class="sd">                    ======================   ==============================================================</span>

<span class="sd">                - **nn_string_expanded_df** (*pd.DataFrame*): table with one row per blockstring (or expanded blockstring)</span>

<span class="sd">                    ======================   ========================================================================</span>
<span class="sd">                    nn_string                concatenated version of nn-blocking columns (sep by ::)</span>
<span class="sd">                    nn_string_full           (optional) if split_names is True, this is the full (un-split) nn_string</span>
<span class="sd">                    ed_string                copy of ed-blocking column</span>
<span class="sd">                    absval_string            copy of abs-value-blocking column</span>
<span class="sd">                    ======================   ========================================================================</span>

<span class="sd">        &#39;&#39;&#39;</span>


        <span class="n">an</span> <span class="o">=</span> <span class="n">an</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Preparing blockstring data.&quot;</span><span class="p">)</span>

        <span class="n">expanded_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nn_string&#39;</span><span class="p">]</span>
        <span class="n">an_use</span> <span class="o">=</span> <span class="n">an</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">split_names</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Splitting last names.&#39;</span><span class="p">)</span>
            <span class="n">an_split_ln</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_last_names</span><span class="p">(</span><span class="n">an</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">last_name_column</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">blocking_scheme</span><span class="p">)</span>
            <span class="n">an_use</span> <span class="o">=</span> <span class="n">an_split_ln</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">expanded_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;nn_string_full&#39;</span><span class="p">)</span>

        <span class="n">expanded_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ed_string&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">absval_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expanded_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;absval_string&#39;</span><span class="p">)</span>

        <span class="n">nn_string_expanded_df</span> <span class="o">=</span> <span class="n">an_use</span><span class="p">[</span><span class="n">expanded_cols</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;nn_string&#39;</span><span class="p">)</span>

        <span class="c1"># create dictionary mapping nn_strings to their record counts</span>
        <span class="c1"># NOTE: dict has two keys, &quot;new&quot; and &quot;old&quot;</span>
        <span class="n">nn_strings_to_num_recs</span> <span class="o">=</span> <span class="n">get_nn_string_counts</span><span class="p">(</span><span class="n">an_use</span><span class="p">)</span>

        <span class="c1"># count last name frequency to establish a measure of how common a name is</span>
        <span class="n">commonness_penalty_lookup</span> <span class="o">=</span> <span class="n">get_common_name_penalties</span><span class="p">(</span>
                <span class="n">an</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">last_name_column</span><span class="p">],</span>
                <span class="n">params</span><span class="o">.</span><span class="n">blocking_thresholds</span><span class="p">[</span><span class="s1">&#39;common_name_max_penalty&#39;</span><span class="p">])</span>
        <span class="n">an_use</span><span class="p">[</span><span class="s1">&#39;commonness_penalty&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">an_use</span><span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">last_name_column</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">commonness_penalty_lookup</span><span class="p">)</span>
        <span class="c1"># NOTE: should the params.last_name_column in the above line be original last name always instead?</span>

        <span class="n">nn_string_info</span> <span class="o">=</span> <span class="n">an_use</span><span class="p">[[</span><span class="s1">&#39;nn_string&#39;</span><span class="p">,</span> <span class="s1">&#39;commonness_penalty&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nn_string_info</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nn_string_info</span><span class="o">.</span><span class="n">nn_string</span><span class="o">.</span><span class="n">nunique</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;More than one last name tied to nn_string, meaning there are &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;multiple commonness_penalties per nn_string. Will cause a weird merge.&#39;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="n">nn_string_info</span><span class="p">[</span><span class="s1">&#39;n_new&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn_string_info</span><span class="o">.</span><span class="n">nn_string</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">nn_strings_to_num_recs</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">])</span>
        <span class="n">nn_string_info</span><span class="p">[</span><span class="s1">&#39;n_existing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn_string_info</span><span class="o">.</span><span class="n">nn_string</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">nn_strings_to_num_recs</span><span class="p">[</span><span class="s1">&#39;existing&#39;</span><span class="p">])</span>
        <span class="n">nn_string_info</span><span class="p">[</span><span class="s1">&#39;n_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn_string_info</span><span class="o">.</span><span class="n">n_new</span> <span class="o">+</span> <span class="n">nn_string_info</span><span class="o">.</span><span class="n">n_existing</span>

        <span class="k">return</span> <span class="n">nn_string_info</span><span class="p">,</span> <span class="n">nn_string_expanded_df</span></div>


<div class="viewcode-block" id="Block.get_query_strings"><a class="viewcode-back" href="../../api.html#namematch.block.Block.get_query_strings">[docs]</a>    <span class="k">def</span> <span class="nf">get_query_strings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nn_string_info</span><span class="p">,</span> <span class="n">blocking_scheme</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Filter to nn_strings that appear in the new data -- these are the only strings</span>
<span class="sd">        for which we need near-neighbors. If incremental is False, this filtering step does nothing.</span>

<span class="sd">        Args:</span>
<span class="sd">            nn_string_info (pd.DataFrame): table with one row per nn_string (or expanded nn_string)</span>

<span class="sd">                ======================   ==============================================================</span>
<span class="sd">                nn_string                concatenated version of nn-blocking columns (sep by ::)</span>
<span class="sd">                commonness_penalty       float indicating how common the last name is</span>
<span class="sd">                n_new                    number of times this nn_string appears in a &quot;new&quot; record</span>
<span class="sd">                n_existing               number of times this nn_string appears in an &quot;existing&quot; record</span>
<span class="sd">                n_total                  number of times this nn_string appears in any record</span>
<span class="sd">                ======================   ==============================================================</span>

<span class="sd">            blocking_scheme (dict): dictionary with info on how to do blocking</span>

<span class="sd">        Returns:</span>
<span class="sd">                tuple: tuple containing:</span>

<span class="sd">                - **nn_string_info_to_query** (*pd.DataFrame*): nn_string_info, subset to nn_strings where n_new &gt; 0</span>
<span class="sd">                - **nn_strings_to_query** (*list*): nn_strings that appear at least once in a &quot;new&quot; record</span>
<span class="sd">                - **shingles_to_query** (*scipy.sparse.csr_matrix*): sparse weighted shingles matrix for the nn_strings that appear in a new record</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">nn_string_info</span> <span class="o">=</span> <span class="n">nn_string_info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">nn_string_info_to_query</span> <span class="o">=</span> <span class="n">nn_string_info</span><span class="p">[</span><span class="n">nn_string_info</span><span class="o">.</span><span class="n">n_new</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">nn_strings_to_query</span> <span class="o">=</span> <span class="n">nn_string_info_to_query</span><span class="o">.</span><span class="n">nn_string</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">shingles_to_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_shingles_matrix</span><span class="p">(</span>
            <span class="n">nn_strings_to_query</span><span class="p">,</span>
            <span class="n">blocking_scheme</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
            <span class="n">blocking_scheme</span><span class="p">[</span><span class="s1">&#39;power&#39;</span><span class="p">],</span>
            <span class="n">matrix_type</span><span class="o">=</span><span class="s1">&#39;query&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">nn_string_info_to_query</span><span class="p">,</span> <span class="n">nn_strings_to_query</span><span class="p">,</span> <span class="n">shingles_to_query</span></div>

<div class="viewcode-block" id="Block.generate_shingles_matrix"><a class="viewcode-back" href="../../api.html#namematch.block.Block.generate_shingles_matrix">[docs]</a>    <span class="nd">@log_runtime_and_memory</span>
    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">generate_shingles_matrix</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">nn_strings</span><span class="p">,</span>
            <span class="n">alpha</span><span class="p">,</span>
            <span class="n">power</span><span class="p">,</span>
            <span class="n">matrix_type</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return a weighted sparse matrix of 2-shingles</span>

<span class="sd">        Args:</span>
<span class="sd">            alpha (float): weight of LAST relative to FIRST</span>
<span class="sd">            power (float): parameter controlling the impact of name length on cosine distance</span>
<span class="sd">            matrix_type (str): description of matrix being built (for logging)</span>
<span class="sd">            verbose (bool): True if status messages desired</span>

<span class="sd">        Returns:</span>
<span class="sd">            scipy.sparse.csr_matrix: Weighted sparse 2-shingles matrix</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">nn_strings</span> <span class="o">=</span> <span class="n">nn_strings</span><span class="p">[:]</span>

        <span class="n">all_shingles</span> <span class="o">=</span> <span class="n">get_all_shingles</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating </span><span class="si">{</span><span class="n">matrix_type</span><span class="si">}</span><span class="s2"> shingles matrix.&quot;</span><span class="p">)</span>

        <span class="c1"># shingles input strings</span>
        <span class="n">vectorizer</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">(</span>
            <span class="n">analyzer</span><span class="o">=</span><span class="s1">&#39;char&#39;</span><span class="p">,</span>
            <span class="n">ngram_range</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span>
            <span class="n">decode_error</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">,</span>
            <span class="n">vocabulary</span><span class="o">=</span><span class="n">all_shingles</span><span class="p">,</span>
            <span class="n">lowercase</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">make_matrix</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
            <span class="n">formatted</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="n">nns</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;::&#39;</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="k">for</span> <span class="n">nns</span> <span class="ow">in</span> <span class="n">nn_strings</span><span class="p">]</span>
            <span class="n">shingles_matrix</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">formatted</span><span class="p">)</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">num</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">shingles_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">power</span><span class="p">)</span>
            <span class="n">shingles_matrix</span> <span class="o">=</span> <span class="n">shingles_matrix</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">shingles_matrix</span>

        <span class="c1"># sum of shingles for the first name should equal 1</span>
        <span class="n">var1_shingles_matrix</span> <span class="o">=</span> <span class="n">make_matrix</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># sum of shingles for the last name should equal alpha</span>
        <span class="n">var2_shingles_matrix</span> <span class="o">=</span> <span class="n">make_matrix</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="c1"># combine weighted matrices</span>
        <span class="n">shingles_matrix</span> <span class="o">=</span> <span class="n">var1_shingles_matrix</span> <span class="o">+</span> <span class="n">var2_shingles_matrix</span>

        <span class="k">return</span> <span class="n">shingles_matrix</span></div>

<div class="viewcode-block" id="Block.load_main_index"><a class="viewcode-back" href="../../api.html#namematch.block.Block.load_main_index">[docs]</a>    <span class="nd">@log_runtime_and_memory</span>
    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">load_main_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index_file</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Load the main index, which is reusable over time as data is added incrementally.</span>

<span class="sd">        Args:</span>
<span class="sd">            index_file (str): path to stored index</span>

<span class="sd">        Returns:</span>
<span class="sd">            nmslib.FloatIndex: nmslib index object</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">ix</span> <span class="o">=</span> <span class="n">prep_index</span><span class="p">()</span>
        <span class="n">ix</span><span class="o">.</span><span class="n">loadIndex</span><span class="p">(</span><span class="n">index_file</span><span class="p">,</span> <span class="n">load_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ix</span></div>

<div class="viewcode-block" id="Block.generate_index"><a class="viewcode-back" href="../../api.html#namematch.block.Block.generate_index">[docs]</a>    <span class="nd">@log_runtime_and_memory</span>
    <span class="k">def</span> <span class="nf">generate_index</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">nn_strings</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="p">,</span>
            <span class="n">M</span><span class="p">,</span>
            <span class="n">efC</span><span class="p">,</span>
            <span class="n">post</span><span class="p">,</span>
            <span class="n">alpha</span><span class="p">,</span>
            <span class="n">power</span><span class="p">,</span>
            <span class="n">print_progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Build an nmslib index based on a list of nn_strings and a set of parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            nn_strings (list): strings of the form &#39;FIRST::LAST&#39; to shingle and put in matrix (rows)</span>
<span class="sd">            num_workers (int): number of threads nmslib should use when parallelizing</span>
<span class="sd">            M, efc, post: nmslib parameters</span>
<span class="sd">            alpha (float): weight of last-name relative to first-name</span>
<span class="sd">            power (float): parameter controlling the impact of name length on cosine distance</span>
<span class="sd">            print_progress (bool): controls verbosity of index creation</span>

<span class="sd">        Returns:</span>
<span class="sd">            nmslib.FloatIndex: nmslib index object</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">index_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;M&#39;</span> <span class="p">:</span> <span class="n">M</span><span class="p">,</span>
            <span class="s1">&#39;indexThreadQty&#39;</span> <span class="p">:</span> <span class="n">num_workers</span><span class="p">,</span>
            <span class="s1">&#39;efConstruction&#39;</span> <span class="p">:</span> <span class="n">efC</span><span class="p">,</span>
            <span class="s1">&#39;post&#39;</span> <span class="p">:</span> <span class="n">post</span>
        <span class="p">}</span>

        <span class="n">shingles_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_shingles_matrix</span><span class="p">(</span><span class="n">nn_strings</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">prep_index</span><span class="p">()</span>
        <span class="c1"># batch load data points</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">ix</span><span class="o">.</span><span class="n">addDataPointBatch</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">shingles_matrix</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">shingles_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
        <span class="n">ix</span><span class="o">.</span><span class="n">createIndex</span><span class="p">(</span><span class="n">index_params</span><span class="p">,</span> <span class="n">print_progress</span><span class="o">=</span><span class="n">print_progress</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ix</span></div>

<div class="viewcode-block" id="Block.get_indices"><a class="viewcode-back" href="../../api.html#namematch.block.Block.get_indices">[docs]</a>    <span class="nd">@log_runtime_and_memory</span>
    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">get_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">all_nn_strings</span><span class="p">,</span> <span class="n">og_blocking_index_file</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Wrapper function coordinating the creation and/or loading of the nmslib indices.</span>

<span class="sd">        Args:</span>
<span class="sd">            params (Parameters object): contains matching parameter values</span>
<span class="sd">            all_nn_strings: list of all unique nn_strings in the data (expanded if split_names is True)</span>
<span class="sd">            og_blocking_index_file: path to a pre-build nmslib index (optional, if doesn&#39;t exist then None)</span>

<span class="sd">        Returns:</span>
<span class="sd">               tuple: tuple containing:</span>

<span class="sd">                - **main_index** (*nmslib.FloatIndex*): the main nmslib index</span>
<span class="sd">                - **main_index_nn_strings** (*list*): nn_strings that are in the main nmslib index</span>
<span class="sd">                - **second_index** (*nmslib.FloatIndex*): the secondary nmslib index for querying new nn_strings during incremental runs (often None)</span>
<span class="sd">                - **second_index_nn_strings** (*list*): nn_strings that are in the secondary nmslib index (often None)</span>
<span class="sd">        &#39;&#39;&#39;</span>


        <span class="n">main_index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">second_index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">main_index_nn_strings</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">second_index_nn_strings</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">build_index_from_scratch</span> <span class="o">=</span> <span class="p">((</span><span class="ow">not</span> <span class="n">params</span><span class="o">.</span><span class="n">incremental</span><span class="p">)</span> <span class="ow">or</span> \
                                    <span class="n">og_blocking_index_file</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="ow">or</span> \
                                    <span class="n">params</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="s1">&#39;rebuild_main_index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;always&#39;</span><span class="p">)</span>

        <span class="c1"># if not build_index_from_scratch so far, check one more time consuming trigger</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">build_index_from_scratch</span><span class="p">)</span> <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="s1">&#39;rebuild_main_index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;if_secondary_index_exceeds_limit&#39;</span><span class="p">:</span>
            <span class="n">main_index_nn_strings</span> <span class="o">=</span> <span class="n">load_main_index_nn_strings</span><span class="p">(</span><span class="n">og_blocking_index_file</span><span class="p">)</span>
            <span class="n">second_index_nn_strings</span> <span class="o">=</span> <span class="n">get_second_index_nn_strings</span><span class="p">(</span><span class="n">all_nn_strings</span><span class="p">,</span> <span class="n">main_index_nn_strings</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">second_index_nn_strings</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">params</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="s1">&#39;secondary_index_limit&#39;</span><span class="p">]:</span>
                <span class="n">build_index_from_scratch</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">build_index_from_scratch</span><span class="p">:</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Building index from scratch.&#39;</span><span class="p">)</span>
            <span class="n">main_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_index</span><span class="p">(</span>
                    <span class="n">all_nn_strings</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">nmslib</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">],</span> <span class="n">params</span><span class="o">.</span><span class="n">nmslib</span><span class="p">[</span><span class="s1">&#39;efC&#39;</span><span class="p">],</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">nmslib</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">],</span> <span class="n">params</span><span class="o">.</span><span class="n">blocking_scheme</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">blocking_scheme</span><span class="p">[</span><span class="s1">&#39;power&#39;</span><span class="p">])</span>
            <span class="n">main_index_nn_strings</span> <span class="o">=</span> <span class="n">all_nn_strings</span><span class="p">[:]</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">second_index_nn_strings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                <span class="n">main_index_nn_strings</span> <span class="o">=</span> <span class="n">load_main_index_nn_strings</span><span class="p">(</span><span class="n">og_blocking_index_file</span><span class="p">)</span>
                <span class="n">second_index_nn_strings</span> <span class="o">=</span> <span class="n">get_second_index_nn_strings</span><span class="p">(</span><span class="n">all_nn_strings</span><span class="p">,</span> <span class="n">main_index_nn_strings</span><span class="p">)</span>

            <span class="c1"># load main index</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Loading main index.&#39;</span><span class="p">)</span>
            <span class="n">main_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_main_index</span><span class="p">(</span><span class="n">og_blocking_index_file</span><span class="p">)</span>

            <span class="c1"># build second index</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">second_index_nn_strings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Building second index.&#39;</span><span class="p">)</span>
                <span class="n">second_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_index</span><span class="p">(</span>
                        <span class="n">second_index_nn_strings</span><span class="p">,</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">nmslib</span><span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">],</span> <span class="n">params</span><span class="o">.</span><span class="n">nmslib</span><span class="p">[</span><span class="s1">&#39;efC&#39;</span><span class="p">],</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">nmslib</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">],</span> <span class="n">params</span><span class="o">.</span><span class="n">blocking_scheme</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">blocking_scheme</span><span class="p">[</span><span class="s1">&#39;power&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">main_index</span><span class="p">,</span> <span class="n">main_index_nn_strings</span><span class="p">,</span> <span class="n">second_index</span><span class="p">,</span> <span class="n">second_index_nn_strings</span></div>

<div class="viewcode-block" id="Block.generate_candidate_pairs"><a class="viewcode-back" href="../../api.html#namematch.block.Block.generate_candidate_pairs">[docs]</a>    <span class="nd">@log_runtime_and_memory</span>
    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">generate_candidate_pairs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">nn_strings_to_query</span><span class="p">,</span>
        <span class="n">shingles_to_query</span><span class="p">,</span>
        <span class="n">nn_string_info</span><span class="p">,</span>
        <span class="n">nn_string_expanded_df</span><span class="p">,</span>
        <span class="n">main_index</span><span class="p">,</span>
        <span class="n">main_index_nn_strings</span><span class="p">,</span>
        <span class="n">second_index</span><span class="p">,</span>
        <span class="n">second_index_nn_strings</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kw</span>
    <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Wrapper function for querying the nmslib index (or indices) and getting</span>
<span class="sd">        non-matching candidate pairs.</span>

<span class="sd">        Args:</span>
<span class="sd">            nn_strings_to_query (list): nn_strings in new data -- those that need near neighbors</span>
<span class="sd">            shingles_to_query (csr_matrix): shingles matrix for nn_strings_to_query</span>
<span class="sd">            nn_string_info (pd.DataFrame):  table with one row per nn_string (or expanded nn_string)</span>
<span class="sd">            nn_string_expanded_df (pd.DataFrame): maps a nn_string to a ed_string and absval_string</span>
<span class="sd">            main_index (nmslib index): the main nmslib index for querying</span>
<span class="sd">            main_index_nn_strings (list): nn_strings in main_index</span>
<span class="sd">            second_index (nmslib index): the secondary nmslib index, for some incremental runs</span>
<span class="sd">            second_index_nn_strings (list): nn_strings in second_index</span>
<span class="sd">            batch_size (int): batch size. Default is 10000 and can be modify in config.yaml file.</span>
<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: candidate-pairs list, before adding in uncovered pairs</span>

<span class="sd">            ======================   =======================================================</span>
<span class="sd">            blockstring_1            concatenated version of blocking columns for first element in pair (sep by ::)</span>
<span class="sd">            blockstring_2            concatenated version of blocking columns for second element in pair (sep by ::)</span>
<span class="sd">            cos_dist                 approximate cosine distance between two nn_strings (nmslib)</span>
<span class="sd">            edit_dist                number of character edits between ed-strings</span>
<span class="sd">            covered_pair             flag; 1 for pairs that made it through blocking, 0 otherwise; all 1s here</span>
<span class="sd">            ======================   =======================================================</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Querying to get candidate pairs.&#39;</span><span class="p">)</span>

        <span class="n">nn_string_info</span> <span class="o">=</span> <span class="n">nn_string_info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># determine which indices to query</span>
        <span class="n">indices_to_query</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">second_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indices_to_query</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;secondary&#39;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Indices to query: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">indices_to_query</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># how many names do we want to query at a time?</span>
        <span class="c1"># runtime/ram tradeoff; can lower if having RAM issues</span>
        <span class="c1"># batch_size = 2000 # NOTE can be parameterized/reduced if RAM is issue</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;batch size: </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">start_ix_batch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">start_ix_batch</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nn_strings_to_query</span><span class="p">):</span>
            <span class="n">end_ix_batch</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_ix_batch</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nn_strings_to_query</span><span class="p">))</span>

            <span class="n">cand_pair_df_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">start_ix_batch</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2"> out of </span><span class="si">%s</span><span class="s2"> nn_strings queried.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">min</span><span class="p">(</span><span class="n">start_ix_batch</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nn_strings_to_query</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">nn_strings_to_query</span><span class="p">)))</span>

            <span class="k">for</span> <span class="n">index_type</span> <span class="ow">in</span> <span class="n">indices_to_query</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">index_type</span> <span class="o">==</span> <span class="s1">&#39;main&#39;</span><span class="p">:</span>
                    <span class="n">index_to_query</span> <span class="o">=</span> <span class="n">main_index</span>
                    <span class="n">nn_strings_this_index</span> <span class="o">=</span> <span class="n">main_index_nn_strings</span><span class="p">[:]</span>
                <span class="k">elif</span> <span class="n">index_type</span> <span class="o">==</span> <span class="s1">&#39;secondary&#39;</span><span class="p">:</span>
                    <span class="n">index_to_query</span> <span class="o">=</span> <span class="n">second_index</span>
                    <span class="n">nn_strings_this_index</span> <span class="o">=</span> <span class="n">second_index_nn_strings</span><span class="p">[:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Variable &quot;index_type&quot; must be &quot;main&quot; or &quot;secondary.&quot;&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>

                <span class="c1"># query the nmslib index:</span>
                <span class="c1"># pass in a group of names, and get back the k most similar names)</span>
                <span class="n">near_neighbors_list</span> <span class="o">=</span> <span class="n">index_to_query</span><span class="o">.</span><span class="n">knnQueryBatch</span><span class="p">(</span>
                    <span class="n">queries</span><span class="o">=</span><span class="n">shingles_to_query</span><span class="p">[</span><span class="n">start_ix_batch</span><span class="p">:</span><span class="n">end_ix_batch</span><span class="p">],</span>
                    <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">nmslib</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span>
                    <span class="n">num_threads</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">num_workers</span><span class="p">)</span>

                <span class="n">nn_strings_queried_this_batch</span> <span class="o">=</span> <span class="n">nn_strings_to_query</span><span class="p">[</span><span class="n">start_ix_batch</span><span class="p">:</span><span class="n">end_ix_batch</span><span class="p">]</span>

                <span class="n">near_neighbors_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_near_neighbors_df</span><span class="p">(</span>
                        <span class="n">near_neighbors_list</span><span class="p">,</span>
                        <span class="n">nn_string_info</span><span class="p">,</span>
                        <span class="n">nn_strings_this_index</span><span class="p">,</span>
                        <span class="n">nn_strings_queried_this_batch</span><span class="p">)</span>

                <span class="c1"># parallelize the paring down for possible candidate pairs to actual candidate pairs</span>
                <span class="n">end_points</span> <span class="o">=</span> <span class="n">get_endpoints</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">near_neighbors_df</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">num_workers</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">parallelize</span><span class="p">:</span>

                    <span class="n">output</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
                    <span class="n">jobs</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">mp</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span>
                            <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_actual_candidates</span><span class="p">,</span>
                            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">near_neighbors_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start_ix_worker</span> <span class="p">:</span> <span class="n">end_ix_worker</span><span class="p">],</span>
                                <span class="n">nn_string_expanded_df</span><span class="p">,</span>
                                <span class="n">nn_strings_to_query</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">blocking_thresholds</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">incremental</span><span class="p">,</span>
                                <span class="n">output</span><span class="p">))</span> <span class="k">for</span> <span class="n">start_ix_worker</span><span class="p">,</span> <span class="n">end_ix_worker</span> <span class="ow">in</span> <span class="n">end_points</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">:</span>
                        <span class="n">job</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

                    <span class="n">cand_pairs_to_add_df</span> <span class="o">=</span> <span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">]</span>

                    <span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">join</span><span class="p">()</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">]</span>
                    <span class="n">failure_occurred</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">job</span><span class="o">.</span><span class="n">exitcode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">failure_occurred</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error occurred in </span><span class="si">%s</span><span class="s2"> worker(s).&quot;</span> <span class="o">%</span> <span class="n">failure_occurred</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error occurred in </span><span class="si">%s</span><span class="s2"> worker(s).&quot;</span> <span class="o">%</span> <span class="n">failure_occurred</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="n">cand_pairs_to_add_df</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">start_ix_worker</span><span class="p">,</span> <span class="n">end_ix_worker</span> <span class="ow">in</span> <span class="n">end_points</span><span class="p">:</span>
                        <span class="n">cand_pairs_to_add_df_this_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_actual_candidates</span><span class="p">(</span>
                                <span class="n">near_neighbors_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">start_ix_worker</span> <span class="p">:</span> <span class="n">end_ix_worker</span><span class="p">],</span>
                                <span class="n">nn_string_expanded_df</span><span class="p">,</span>
                                <span class="n">nn_strings_to_query</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">blocking_thresholds</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">incremental</span><span class="p">)</span>
                        <span class="n">cand_pairs_to_add_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cand_pairs_to_add_df_this_iter</span><span class="p">)</span>

                <span class="n">cand_pair_df_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cand_pairs_to_add_df</span><span class="p">)</span>

            <span class="n">start_ix_batch</span> <span class="o">+=</span> <span class="n">batch_size</span>

            <span class="n">cand_pair_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">cand_pair_df_list</span><span class="p">)</span>
            <span class="n">cand_pair_df</span> <span class="o">=</span> <span class="n">cand_pair_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;blockstring_1&#39;</span><span class="p">,</span> <span class="s1">&#39;blockstring_2&#39;</span><span class="p">])</span>
            <span class="c1"># because same name might be in both indices</span>

            <span class="c1"># update total number candidate pairs generated so far; write to file</span>
            <span class="n">write_some_cps</span><span class="p">(</span><span class="n">cand_pair_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">candidate_pairs_file</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">cand_pair_df</span>

        <span class="c1"># have to load so we can drop duplicates at global level...</span>
        <span class="c1"># because of split names</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Loading candidate pairs to drop duplicates.&#39;</span><span class="p">)</span>
        <span class="n">cand_pair_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">candidate_pairs_file</span><span class="p">)</span>
        <span class="n">cand_pair_df</span> <span class="o">=</span> <span class="n">cand_pair_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;blockstring_1&#39;</span><span class="p">,</span> <span class="s1">&#39;blockstring_2&#39;</span><span class="p">])</span>
        <span class="n">cand_pair_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">candidate_pairs_file</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_NONNUMERIC</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cand_pair_df</span></div>

<div class="viewcode-block" id="Block.compute_cosine_sim"><a class="viewcode-back" href="../../api.html#namematch.block.Block.compute_cosine_sim">[docs]</a>    <span class="nd">@log_runtime_and_memory</span>
    <span class="k">def</span> <span class="nf">compute_cosine_sim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blockstrings_in_pairs</span><span class="p">,</span> <span class="n">pairs_df</span><span class="p">,</span> <span class="n">shingles_matrix</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Fast cosine similarity computation using the shingles matrix.</span>

<span class="sd">        Args:</span>
<span class="sd">            blockstrings_in_pairs (list): used to get index of different strings in shingles_matrix</span>
<span class="sd">            pairs_df (pd.DataFrame): blockstrings you want cosine distance between</span>

<span class="sd">               ===================   =======================================================</span>
<span class="sd">               blockstring_1         blockstring for the first record in the pair</span>
<span class="sd">               blockstring_2         blockstring for the second record in the pair</span>
<span class="sd">               covered_pair          flag, 1 if covered 0 otherwise</span>
<span class="sd">               nn_strings_1          nn_string for the first record in the pair</span>
<span class="sd">               nn_strings_2          nn_string for the second record in the pair</span>
<span class="sd">               both_nn_strings       nn_string_1 + &#39; &#39; + nn_string_2</span>
<span class="sd">               ===================   =======================================================</span>

<span class="sd">        Returns:</span>
<span class="sd">            shingles_matrix (csr_matrix): weighted shingles matrix</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">name_index_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">the_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">blockstrings_in_pairs</span><span class="p">):</span>
            <span class="n">name_index_map</span><span class="p">[</span><span class="n">the_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

        <span class="n">idx1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">idx2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;blockstring_1&#39;</span><span class="p">]</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;blockstring_2&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">n1</span> <span class="ow">in</span> <span class="n">name_index_map</span> <span class="ow">and</span> <span class="n">n2</span> <span class="ow">in</span> <span class="n">name_index_map</span><span class="p">:</span>
                <span class="n">idx1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_index_map</span><span class="p">[</span><span class="n">n1</span><span class="p">])</span>
                <span class="n">idx2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_index_map</span><span class="p">[</span><span class="n">n2</span><span class="p">])</span>

        <span class="n">mat1</span> <span class="o">=</span> <span class="n">shingles_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idx1</span><span class="p">)]</span>
        <span class="n">mat2</span> <span class="o">=</span> <span class="n">shingles_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idx2</span><span class="p">)]</span>

        <span class="n">numerator</span> <span class="o">=</span> <span class="n">mat1</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mat2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">mat1_squared</span> <span class="o">=</span> <span class="n">mat1</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mat1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mat2_squared</span> <span class="o">=</span> <span class="n">mat2</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mat2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mat1_squared</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mat2_squared</span><span class="p">))</span>

        <span class="n">pair_cos</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">numerator</span><span class="p">,</span> <span class="n">denom</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing cosine similarities.&#39;</span><span class="p">)</span>

        <span class="n">pair_cos</span> <span class="o">=</span> <span class="n">pair_cos</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">pair_cos</span></div>

<div class="viewcode-block" id="Block.evaluate_blocking"><a class="viewcode-back" href="../../api.html#namematch.block.Block.evaluate_blocking">[docs]</a>    <span class="nd">@log_runtime_and_memory</span>
    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">evaluate_blocking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cp_df</span><span class="p">,</span> <span class="n">tp_df</span><span class="p">,</span> <span class="n">blocking_scheme</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;The evaluate_blocking function computes the pair completeness metrics to</span>
<span class="sd">        determine how successful blocking was at minimizing comparisons and</span>
<span class="sd">        maximizing true positives (i.e. generating a candidate pair between</span>
<span class="sd">        records that are actually matches).</span>

<span class="sd">        Args:</span>
<span class="sd">            cp_df (pd.DataFrame): candidate pairs df</span>
<span class="sd">            tp_df (pd.DataFrame): true pairs df (blockstring_1, blockstring_2)</span>
<span class="sd">            blocking_scheme (dict): blocking_scheme (dict): dictionary with info on how to do blocking</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: portion of candidate-pairs dataframe where covered == 0</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">cp_df</span> <span class="o">=</span> <span class="n">cp_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">cp_df</span><span class="p">[</span><span class="s1">&#39;nn_string_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span>
                <span class="n">get_nn_string_from_blockstring</span><span class="p">,</span> <span class="n">otypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">])(</span><span class="n">cp_df</span><span class="o">.</span><span class="n">blockstring_1</span><span class="p">)</span>
        <span class="n">cp_df</span><span class="p">[</span><span class="s1">&#39;nn_string_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span>
                <span class="n">get_nn_string_from_blockstring</span><span class="p">,</span> <span class="n">otypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">])(</span><span class="n">cp_df</span><span class="o">.</span><span class="n">blockstring_2</span><span class="p">)</span>
        <span class="n">cp_df</span><span class="p">[</span><span class="s1">&#39;both_blockstrings&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">cp_df</span><span class="o">.</span><span class="n">blockstring_1</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">cp_df</span><span class="o">.</span><span class="n">blockstring_2</span>
        <span class="n">cp_df</span><span class="p">[</span><span class="s1">&#39;both_nn_strings&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">cp_df</span><span class="o">.</span><span class="n">nn_string_1</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">cp_df</span><span class="o">.</span><span class="n">nn_string_2</span>

        <span class="c1"># covered/uncovered pairs (get cosine distribution)</span>
        <span class="c1"># -----------------------------------------------</span>

        <span class="n">pasted</span> <span class="o">=</span> <span class="n">tp_df</span><span class="p">[</span><span class="s2">&quot;blockstring_1&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">tp_df</span><span class="p">[</span><span class="s2">&quot;blockstring_2&quot;</span><span class="p">]</span>
        <span class="n">tp_df</span><span class="p">[</span><span class="s2">&quot;covered_pair&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pasted</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cp_df</span><span class="p">[</span><span class="s2">&quot;both_blockstrings&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">tp_df</span><span class="p">[</span><span class="s1">&#39;nn_string_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span>
                <span class="n">get_nn_string_from_blockstring</span><span class="p">,</span> <span class="n">otypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">])(</span><span class="n">tp_df</span><span class="o">.</span><span class="n">blockstring_1</span><span class="p">)</span>
        <span class="n">tp_df</span><span class="p">[</span><span class="s1">&#39;nn_string_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span>
                <span class="n">get_nn_string_from_blockstring</span><span class="p">,</span> <span class="n">otypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">])(</span><span class="n">tp_df</span><span class="o">.</span><span class="n">blockstring_2</span><span class="p">)</span>
        <span class="n">tp_df</span><span class="p">[</span><span class="s1">&#39;both_nn_strings&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">tp_df</span><span class="o">.</span><span class="n">nn_string_1</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">tp_df</span><span class="o">.</span><span class="n">nn_string_2</span>

        <span class="n">tp_df_nonmatching</span> <span class="o">=</span> \
                <span class="n">tp_df</span><span class="p">[</span><span class="n">tp_df</span><span class="o">.</span><span class="n">blockstring_1</span> <span class="o">!=</span> <span class="n">tp_df</span><span class="o">.</span><span class="n">blockstring_2</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># calculate cosine distance between true pairs (non-matching)</span>
        <span class="n">blockstrings_in_true_pairs</span> <span class="o">=</span> \
                <span class="n">tp_df</span><span class="o">.</span><span class="n">blockstring_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">tp_df</span><span class="o">.</span><span class="n">blockstring_2</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">tp_shingles_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_shingles_matrix</span><span class="p">(</span>
                <span class="n">blockstrings_in_true_pairs</span><span class="p">,</span>
                <span class="n">blocking_scheme</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="n">blocking_scheme</span><span class="p">[</span><span class="s1">&#39;power&#39;</span><span class="p">],</span>
                <span class="n">matrix_type</span><span class="o">=</span><span class="s1">&#39;true pairs&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">tp_df_nonmatching</span><span class="p">[</span><span class="s1">&#39;cos_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_cosine_sim</span><span class="p">(</span><span class="n">blockstrings_in_true_pairs</span><span class="p">,</span>
                <span class="n">tp_df_nonmatching</span><span class="p">,</span> <span class="n">tp_shingles_matrix</span><span class="p">)</span>

        <span class="c1"># get the distribution of cosine distances in non-matching true pairs</span>
        <span class="n">tp_nonmatching_cos_distr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">tp_df_nonmatching</span><span class="o">.</span><span class="n">cos_dist</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">.1</span><span class="p">)),</span>
                <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cosine distribution of non-matching true pairs: </span><span class="se">\n</span><span class="si">{</span><span class="n">tp_nonmatching_cos_distr</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;tp_cosine_distribution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp_nonmatching_cos_distr</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># output uncovered pairs so we can see where blocking fails</span>
        <span class="n">up_df</span> <span class="o">=</span> <span class="n">tp_df_nonmatching</span><span class="p">[</span><span class="n">tp_df_nonmatching</span><span class="o">.</span><span class="n">covered_pair</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">up_df</span><span class="p">[</span><span class="s1">&#39;ed_string_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span>
                <span class="n">get_ed_string_from_blockstring</span><span class="p">,</span> <span class="n">otypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">])(</span><span class="n">up_df</span><span class="o">.</span><span class="n">blockstring_1</span><span class="p">)</span>
        <span class="n">up_df</span><span class="p">[</span><span class="s1">&#39;ed_string_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span>
                <span class="n">get_ed_string_from_blockstring</span><span class="p">,</span> <span class="n">otypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">])(</span><span class="n">up_df</span><span class="o">.</span><span class="n">blockstring_2</span><span class="p">)</span>
        <span class="n">up_df</span><span class="p">[</span><span class="s1">&#39;edit_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">editdistance</span><span class="o">.</span><span class="n">eval</span><span class="p">,</span> <span class="n">otypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">])(</span>
                <span class="n">up_df</span><span class="o">.</span><span class="n">ed_string_1</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">up_df</span><span class="o">.</span><span class="n">ed_string_2</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">up_df</span> <span class="o">=</span> <span class="n">up_df</span><span class="p">[[</span><span class="s1">&#39;blockstring_1&#39;</span><span class="p">,</span> <span class="s1">&#39;blockstring_2&#39;</span><span class="p">,</span> <span class="s1">&#39;cos_dist&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;edit_dist&#39;</span><span class="p">,</span> <span class="s1">&#39;covered_pair&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of uncovered pairs: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">up_df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;n_uncovered_pairs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">up_df</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of true pairs: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tp_df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;n_true_blockstring_pairs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tp_df</span><span class="p">)</span>

        <span class="c1"># get the distribution of cosine distances in uncovered pairs</span>
        <span class="c1"># NOTE: fine that coming from non-matching df because no uncovered pairs will ever match</span>
        <span class="n">uncovered_pair_cos_distr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">up_df</span><span class="o">.</span><span class="n">cos_dist</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">.1</span><span class="p">)),</span>
                <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cosine distribution of uncovered pairs: </span><span class="se">\n</span><span class="si">{</span><span class="n">uncovered_pair_cos_distr</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;up_cosine_distribution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uncovered_pair_cos_distr</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># pair completeness, aka pc (high is good, max 1)</span>
        <span class="c1"># -----------------------------------------------</span>
        <span class="c1"># this is the proportion of actual matches that make it through blocking</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating pair completeness.&quot;</span><span class="p">)</span>

        <span class="c1"># calculate pair completeness for all candidate pairs</span>
        <span class="n">pc_numerator_nn_string_level</span> <span class="o">=</span> <span class="n">tp_df</span><span class="p">[</span><span class="n">tp_df</span><span class="o">.</span><span class="n">both_nn_strings</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
                <span class="n">cp_df</span><span class="o">.</span><span class="n">both_nn_strings</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span><span class="o">.</span><span class="n">both_nn_strings</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="n">pc_numerator_blockstring_level</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">up_df</span><span class="p">)</span>
        <span class="n">pc_denominator_nn_string_level</span> <span class="o">=</span> <span class="n">tp_df</span><span class="o">.</span><span class="n">both_nn_strings</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="n">pc_denominator_blockstring_level</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tp_df</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pc_nn_string_level</span> <span class="o">=</span> \
                    <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">pc_numerator_nn_string_level</span> <span class="o">/</span> <span class="n">pc_denominator_nn_string_level</span><span class="p">)</span>
            <span class="n">pc_blockstring_level</span> <span class="o">=</span> \
                    <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">pc_numerator_blockstring_level</span> <span class="o">/</span> <span class="n">pc_denominator_blockstring_level</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pair completeness, including equal blockstrings (cosine level): </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">pc_nn_string_level</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;pc_eq_cos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">pc_nn_string_level</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pair completeness, including equal blockstrings (cosine + editdistance level): </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">pc_blockstring_level</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;pc_eq_cosed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">pc_blockstring_level</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pair completeness cannot be calculated. Make sure necessary &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;files are populated.&quot;</span><span class="p">)</span>

        <span class="c1"># calculate pair completeness for candidate pairs that are not the</span>
        <span class="c1"># same (e.g. NameX, NameX) since those should be perfect</span>
        <span class="n">pc_denominator_nonequal_nn_string_level</span> <span class="o">=</span> \
                <span class="n">tp_df</span><span class="p">[</span><span class="n">tp_df</span><span class="o">.</span><span class="n">nn_string_1</span> <span class="o">!=</span> <span class="n">tp_df</span><span class="o">.</span><span class="n">nn_string_2</span><span class="p">]</span><span class="o">.</span><span class="n">both_nn_strings</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
        <span class="n">pc_denominator_nonequal_blockstring_level</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tp_df_nonmatching</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pc_nn_string_level</span> <span class="o">=</span> \
                    <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">pc_numerator_nn_string_level</span> <span class="o">/</span> <span class="n">pc_denominator_nonequal_nn_string_level</span><span class="p">)</span>
            <span class="n">pc_blockstring_level</span> <span class="o">=</span> \
                    <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">pc_numerator_blockstring_level</span> <span class="o">/</span> <span class="n">pc_denominator_nonequal_blockstring_level</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pair completeness, non-equal blockstrings (cosine level): </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">pc_nn_string_level</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;pc_neq_cos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">pc_nn_string_level</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pair completeness, non-equal blockstrings (cosine + editdistance level): </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">pc_blockstring_level</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;pc_neq_cosed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">pc_blockstring_level</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pair completeness (non-equal blockstrings) cannot be calculated. &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;Make sure necessary files are populated.&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished evaluating blocking.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">up_df</span></div>

<div class="viewcode-block" id="Block.add_uncovered_pairs"><a class="viewcode-back" href="../../api.html#namematch.block.Block.add_uncovered_pairs">[docs]</a>    <span class="k">def</span> <span class="nf">add_uncovered_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">candidate_pairs_df</span><span class="p">,</span> <span class="n">uncovered_pairs_df</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add the uncovered pairs to the candidate pairs dataframe so that all of the</span>
<span class="sd">        known pairs are in the candidate pairs list.</span>

<span class="sd">        Args:</span>
<span class="sd">            candidate_pairs_df (pd.DataFrame): candidate pairs file produced by blocking</span>
<span class="sd">            uncovered_pairs_df (pd.DataFrame): uncovered pairs produced by evaluating blocking</span>

<span class="sd">        Return:</span>
<span class="sd">            pd.DataFrame: candidate-pairs file</span>

<span class="sd">            ======================   =======================================================</span>
<span class="sd">            blockstring_1            concatenated version of blocking columns for first element in pair (sep by ::)</span>
<span class="sd">            blockstring_2            concatenated version of blocking columns for second element in pair (sep by ::)</span>
<span class="sd">            cos_dist                 approximate cosine distance between two nn_strings (nmslib)</span>
<span class="sd">            edit_dist                number of character edits between ed-strings</span>
<span class="sd">            covered_pair             flag; 1 for pairs that made it through blocking, 0 otherwise</span>
<span class="sd">            ======================   =======================================================</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Blocked covered pairs: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">candidate_pairs_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;n_bcp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_pairs_df</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Uncovered pairs: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">uncovered_pairs_df</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;n_uncovered_pairs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">uncovered_pairs_df</span><span class="p">)</span>

        <span class="n">up_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">uncovered_pairs_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">candidate_pairs_df</span><span class="p">]</span>
        <span class="n">candidate_pairs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
                <span class="n">candidate_pairs_df</span><span class="p">,</span>
                <span class="n">uncovered_pairs_df</span><span class="p">[</span><span class="n">up_cols</span><span class="p">]],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">candidate_pairs_df</span> <span class="o">=</span> <span class="n">candidate_pairs_df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;n_cand_pairs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_pairs_df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">candidate_pairs_df</span></div>

<div class="viewcode-block" id="Block.apply_blocking_filter"><a class="viewcode-back" href="../../api.html#namematch.block.Block.apply_blocking_filter">[docs]</a>    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">apply_blocking_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">thresholds</span><span class="p">,</span> <span class="n">nn_string_expanded_df</span><span class="p">,</span> <span class="n">nns_match</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Compare similarity of names and DOBs to see if a pair of records are likely to be a match.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame): holds similarity and commonness info about pairs of names</span>

<span class="sd">                ======================   ==================================================================================</span>
<span class="sd">                nn_string_1              concatenated version of nn-blocking columns for first element in pair (sep by ::)</span>
<span class="sd">                nn_string_2              concatenated version of nn-blocking columns for second element in pair (sep by ::)</span>
<span class="sd">                cos_dist                 approximate cosine distance between two nn_strings (nmslib)</span>
<span class="sd">                commonness_penalty_1     penalty for last-name commonness for first element in pair</span>
<span class="sd">                commonness_penalty_2     penalty for last-name commonness for second element in pair</span>
<span class="sd">                ======================   ==================================================================================</span>

<span class="sd">            thresholds (dict): information about what blocking distances are allowed</span>
<span class="sd">            nn_string_expanded_df (pd.DataFrame): maps a nn_string to a ed_string and absval_string</span>
<span class="sd">            nns_match (bool): True if this function is called by get_exact_match_candidate_pairs</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: chunk of the candidate-pairs list</span>

<span class="sd">            ==============   ===============================================================================</span>
<span class="sd">            blockstring_1    concatenated version of blocking columns for first element in pair (sep by ::)</span>
<span class="sd">            blockstring_2    concatenated version of blocking columns for second element in pair (sep by ::)</span>
<span class="sd">            cos_dist         approximate cosine distance between two nn_strings (nmslib)</span>
<span class="sd">            edit_dist        number of character edits between ed-strings</span>
<span class="sd">            covered_pair     flag; 1 for pairs that made it through blocking, 0 otherwise; all 1s here</span>
<span class="sd">            ==============   ===============================================================================</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># add commonness penalty</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;commonness_penalty&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;commonness_penalty_1&#39;</span><span class="p">,</span> <span class="s1">&#39;commonness_penalty_2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;commonness_penalty_1&#39;</span><span class="p">,</span> <span class="s1">&#39;commonness_penalty_2&#39;</span><span class="p">])</span>

        <span class="c1"># expand to full-name/dob/age(?) level</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">nn_string_expanded_df</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;nn_string_1&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">nn_string_expanded_df</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;nn_string_2&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;_1&#39;</span><span class="p">,</span> <span class="s1">&#39;_2&#39;</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;nn_string_full&#39;</span> <span class="ow">in</span> <span class="n">nn_string_expanded_df</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;nn_string_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">nn_string_full_1</span> <span class="c1"># swap nn_string for nn_string_full</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;nn_string_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">nn_string_full_2</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nn_string_full_1&#39;</span><span class="p">,</span> <span class="s1">&#39;nn_string_full_2&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">nns_match</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">ed_string_1</span> <span class="o">&lt;=</span> <span class="n">df</span><span class="o">.</span><span class="n">ed_string_2</span><span class="p">]</span>

        <span class="c1"># use dob columns to calculate edit distance</span>
        <span class="c1"># initialize as either 0 (if equal and not null) or -1</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;edit_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">ed_string_1</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ed_string_1</span> <span class="o">==</span> <span class="n">df</span><span class="o">.</span><span class="n">ed_string_2</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">where_calc_ed</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">ed_string_1</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ed_string_2</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">ed_string_1</span> <span class="o">!=</span> <span class="n">df</span><span class="o">.</span><span class="n">ed_string_2</span><span class="p">))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">where_calc_ed</span><span class="p">,</span> <span class="s1">&#39;edit_dist&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">editdistance</span><span class="o">.</span><span class="n">eval</span><span class="p">,</span> <span class="n">otypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float&#39;</span><span class="p">])(</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">where_calc_ed</span><span class="p">]</span><span class="o">.</span><span class="n">ed_string_1</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">where_calc_ed</span><span class="p">]</span><span class="o">.</span><span class="n">ed_string_2</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;absval_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="s1">&#39;absval_string_1&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
            <span class="c1"># need to collapse to name/age level</span>
            <span class="n">gb_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;absval&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;absval_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">absval_string_1</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">absval_string_2</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">gb_cols</span><span class="p">)</span><span class="o">.</span><span class="n">absval_diff</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># limit to the pairs that are most likely to be the same person</span>
        <span class="n">pass_high_bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">cos_dist</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;high_cosine_bar&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">commonness_penalty</span><span class="p">))</span> <span class="o">&amp;</span> \
                        <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">edit_dist</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> \
                        <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">edit_dist</span> <span class="o">&lt;=</span> <span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;low_editdist_bar&#39;</span><span class="p">])</span>

        <span class="n">pass_low_bar</span> <span class="o">=</span>  <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">cos_dist</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;low_cosine_bar&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">commonness_penalty</span><span class="p">))</span> <span class="o">&amp;</span> \
                        <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">edit_dist</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> \
                        <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">edit_dist</span> <span class="o">&lt;=</span> <span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;high_editdist_bar&#39;</span><span class="p">])</span>

        <span class="n">pass_nodob_bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">cos_dist</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;nodob_cosine_bar&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">commonness_penalty</span><span class="p">))</span> <span class="o">&amp;</span> \
                         <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">edit_dist</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> \
                         <span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">absval_diff</span> <span class="o">&lt;=</span> <span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;absvalue_bar&#39;</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">absval_diff</span><span class="o">.</span><span class="n">isnull</span><span class="p">()))</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">pass_high_bar</span> <span class="o">|</span> <span class="n">pass_low_bar</span> <span class="o">|</span> <span class="n">pass_nodob_bar</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># flip any strings that are not in alphabetical order</span>
        <span class="c1"># NOTE: necessary for incremental runs</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;nns1_is_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">nn_string_1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;::&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">nn_string_2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;::&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;blockstring_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">nn_string_1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;::&#39;</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">ed_string_1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;blockstring_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">nn_string_2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;::&#39;</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">ed_string_2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">nns1_is_min</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;blockstring_1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">nn_string_2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;::&#39;</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">ed_string_2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">nns1_is_min</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;blockstring_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">nn_string_1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;::&#39;</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">ed_string_1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="n">cand_pairs</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;blockstring_1&#39;</span><span class="p">,</span> <span class="s1">&#39;blockstring_2&#39;</span><span class="p">,</span> <span class="s1">&#39;cos_dist&#39;</span><span class="p">,</span> <span class="s1">&#39;edit_dist&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># once we&#39;ve applied all the filters, the rows that are left will make it through blocking</span>
        <span class="n">cand_pairs</span><span class="p">[</span><span class="s1">&#39;covered_pair&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">cand_pairs</span></div>


<div class="viewcode-block" id="Block.disallow_switched_pairs"><a class="viewcode-back" href="../../api.html#namematch.block.Block.disallow_switched_pairs">[docs]</a>    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">disallow_switched_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">incremental</span><span class="p">,</span> <span class="n">nn_strings_to_query</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Look through the columns nn_string_1 and nn_string_2 and keep only rows where</span>
<span class="sd">        nn_string1 &lt;= nn_string2 to prevent duplicates in the end (i.e. ABBY-&gt;ZABBY &amp;</span>
<span class="sd">        ZABBY-&gt;ABBY; only one is needed). Special case for incremental runs.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame): holds similarity and commonness info about pairs of names</span>
<span class="sd">            incremental (bool) : Ture if current run incremental</span>
<span class="sd">            nn_strings_to_query (list): nn_strings that are in &quot;to query&quot; list</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: same as input df, but no AB/BA duplicates</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># hack to help make sure things are ordered properly</span>
        <span class="c1"># e.g. JOHN SMITH JR &gt; JOHN SMITH, but # e.g. JOHN SMITH JR:: &lt; JOHN SMITH::</span>
        <span class="c1"># e.g. JOHN SMITH-JONES &gt; JOHN SMITH, but # e.g. JOHN SMITH-JONES:: &lt; JOHN SMITH::</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;nn_string_1_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">nn_string_1</span> <span class="o">+</span> <span class="s1">&#39;::&#39;</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;nn_string_2_&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">nn_string_2</span> <span class="o">+</span> <span class="s1">&#39;::&#39;</span>

        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;allowed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">nn_string_1_</span> <span class="o">&lt;</span> <span class="n">df</span><span class="o">.</span><span class="n">nn_string_2_</span><span class="p">,</span> <span class="s1">&#39;allowed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">incremental</span><span class="p">)</span> <span class="o">&amp;</span>
              <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">nn_string_1_</span> <span class="o">&gt;</span> <span class="n">df</span><span class="o">.</span><span class="n">nn_string_2_</span><span class="p">)</span> <span class="o">&amp;</span>
              <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">nn_string_2</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">nn_strings_to_query</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">),</span> <span class="s1">&#39;allowed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">allowed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nn_string_1_&#39;</span><span class="p">,</span> <span class="s1">&#39;nn_string_2_&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="Block.get_actual_candidates"><a class="viewcode-back" href="../../api.html#namematch.block.Block.get_actual_candidates">[docs]</a>    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">get_actual_candidates</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">near_neighbors_df</span><span class="p">,</span>
            <span class="n">nn_string_expanded_df</span><span class="p">,</span>
            <span class="n">nn_strings_to_query</span><span class="p">,</span>
            <span class="n">thresholds</span><span class="p">,</span>
            <span class="n">incremental</span><span class="p">,</span>
            <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Actually determines whether two names become candidates; this function is launched by</span>
<span class="sd">        generate_candidate_pairs() and run on individual worker threads to speed up processing.</span>

<span class="sd">        Args:</span>

<span class="sd">            near_neighbors_df (pd.DataFrame): holds similarity and commonness info about pairs of names</span>

<span class="sd">                ======================   =======================================================</span>
<span class="sd">                nn_string_ix             a string with nn_string_ix = i is the string located at nn_strings_queried_this_batch[i]</span>
<span class="sd">                nn_string_1              concatenated version of nn-blocking columns for first element in pair (sep by ::)</span>
<span class="sd">                nn_string_2              concatenated version of nn-blocking columns for second element in pair (sep by ::)</span>
<span class="sd">                cos_dist                 approximate cosine distance between two nn_strings (nmslib)</span>
<span class="sd">                commonness_penalty_1     penalty for last-name commonness for first element in pair</span>
<span class="sd">                commonness_penalty_2     penalty for last-name commonness for second element in pair</span>
<span class="sd">                ======================   =======================================================</span>

<span class="sd">            nn_string_expanded_df (pandas dataframe): table at nn_string/ed_string/absval_string level (expanded if split_name is True)</span>
<span class="sd">            nn_strings_to_query (list): nn_strings in the &quot;to query&quot; list (needed for incremental check)</span>
<span class="sd">            thresholds (dict): information about what blocking distances are allowed</span>
<span class="sd">            incremental (bool) : True if current run incremental</span>
<span class="sd">            output: None if the output should be returned, rather than written</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: chunk of the candidate-pairs list</span>

<span class="sd">            ======================   =======================================================</span>
<span class="sd">            blockstring_1            concatenated version of blocking columns for first element in pair (sep by ::)</span>
<span class="sd">            blockstring_2            concatenated version of blocking columns for second element in pair (sep by ::)</span>
<span class="sd">            cos_dist                 approximate cosine distance between two nn_strings (nmslib)</span>
<span class="sd">            edit_dist                number of character edits between ed-strings</span>
<span class="sd">            covered_pair             flag; 1 for pairs that made it through blocking, 0 otherwise; all 1s here</span>
<span class="sd">            ======================   =======================================================</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">near_neighbors_df</span> <span class="o">=</span> <span class="n">near_neighbors_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># narrow down to reasaonable cosine distance</span>
        <span class="n">near_neighbors_df</span> <span class="o">=</span> <span class="n">near_neighbors_df</span><span class="p">[</span><span class="n">near_neighbors_df</span><span class="o">.</span><span class="n">cos_dist</span> <span class="o">&lt;=</span> <span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;low_cosine_bar&#39;</span><span class="p">]]</span>

        <span class="c1"># narrow down so we don&#39;t have duplicates (AB &amp; BA)</span>
        <span class="n">near_neighbors_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disallow_switched_pairs</span><span class="p">(</span><span class="n">near_neighbors_df</span><span class="p">,</span> <span class="n">incremental</span><span class="p">,</span> <span class="n">nn_strings_to_query</span><span class="p">)</span>

        <span class="c1"># filter out low edit or cosine distances</span>
        <span class="n">cand_pairs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_blocking_filter</span><span class="p">(</span><span class="n">near_neighbors_df</span><span class="p">,</span> <span class="n">thresholds</span><span class="p">,</span> <span class="n">nn_string_expanded_df</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cand_pairs_df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">cand_pairs_df</span><span class="p">)</span></div>


<div class="viewcode-block" id="Block.get_near_neighbors_df"><a class="viewcode-back" href="../../api.html#namematch.block.Block.get_near_neighbors_df">[docs]</a>    <span class="nd">@profile</span>
    <span class="k">def</span> <span class="nf">get_near_neighbors_df</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">near_neighbors_list</span><span class="p">,</span>
            <span class="n">nn_string_info</span><span class="p">,</span>
            <span class="n">nn_strings_this_index</span><span class="p">,</span>
            <span class="n">nn_strings_queried_this_batch</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;For a small batch of names (nn_strings_queried_this_batch), format a dataframe that</span>
<span class="sd">        enumerates every pair of (name in this batch, a near neighbor), along with information about</span>
<span class="sd">        similarity and commonness.</span>

<span class="sd">        Args:</span>
<span class="sd">            near_neighbors_list (list): list of (list of k IDs, list of k distances) tuples, of length batch_size</span>
<span class="sd">            nn_string_info (pd.DataFrame): table mapping nn_string to commonness_penalty</span>
<span class="sd">            nn_strings_this_index (list): nn_strings in the current index</span>
<span class="sd">            nn_strings_queried_this_batch (list): nn_strings in the current query batch (length batch_size),</span>
<span class="sd">                                                  whose neighbors are stored in near_neighbors_list</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: holds similarity and commonness info about pairs of names</span>

<span class="sd">            ====================   ========================================================================================</span>
<span class="sd">            nn_string_ix           a string with nn_string_ix = i is the string located at nn_strings_queried_this_batch[i]</span>
<span class="sd">            nn_string_1            concatenated version of nn-blocking columns for first element in pair (sep by ::)</span>
<span class="sd">            nn_string_2            concatenated version of nn-blocking columns for second element in pair (sep by ::)</span>
<span class="sd">            cos_dist               approximate cosine distance between two nn_strings (nmslib)</span>
<span class="sd">            commonness_penalty_1   penalty for last-name commonness for first element in pair</span>
<span class="sd">            commonness_penalty_2   penalty for last-name commonness for second element in pair</span>
<span class="sd">            ====================   ========================================================================================</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">nn_strings_this_index</span> <span class="o">=</span> <span class="n">nn_strings_this_index</span><span class="p">[:]</span>
        <span class="n">nn_strings_queried_this_batch</span> <span class="o">=</span> <span class="n">nn_strings_queried_this_batch</span><span class="p">[:]</span>
        <span class="n">nn_string_info</span> <span class="o">=</span> <span class="n">nn_string_info</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">nn_string_info</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;nn_string&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">nn_string_info_queried_this_batch</span> <span class="o">=</span> <span class="n">nn_string_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">nn_strings_queried_this_batch</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">nn_string_info_this_index</span> <span class="o">=</span> <span class="n">nn_string_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">nn_strings_this_index</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># each item in these two columns is a list of length k</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">near_neighbors_list</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;near_neighbor_nn_string_ix&#39;</span><span class="p">,</span> <span class="s1">&#39;cos_dist&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;nn_string_ix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># extract the k neighbor IDs, and k distances from the lists, so each is in its own cell</span>
        <span class="c1"># a string with nn_string_ix = i is the string located at nn_strings_queried_this_batch[i]</span>
        <span class="c1"># a string with nn_string_ix = i has its neighbors located at near_neighbors_list[i]</span>
        <span class="c1"># a string with near_neighbor_nn_string_ix = i is the string located at nn_strings_this_index[i]</span>
        <span class="n">list_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;near_neighbor_nn_string_ix&#39;</span><span class="p">,</span> <span class="s1">&#39;cos_dist&#39;</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
          <span class="n">col</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">list_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">())</span>
          <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">list_cols</span><span class="p">)}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">list_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">list_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                    <span class="n">list_cols</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">list_cols</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)})[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

        <span class="c1"># above, nn_string_ix is indices</span>
        <span class="c1"># match these indices to the string they correspond to in nn_strings_queried_this_batch</span>
        <span class="c1"># (and its commonness_penalty)</span>
        <span class="n">nn_string_info_mini</span> <span class="o">=</span> <span class="n">nn_string_info_queried_this_batch</span><span class="p">[[</span><span class="s1">&#39;nn_string&#39;</span><span class="p">,</span> <span class="s1">&#39;commonness_penalty&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">nn_string_info_mini</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nn_string_1&#39;</span><span class="p">,</span> <span class="s1">&#39;commonness_penalty_1&#39;</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">nn_string_info_mini</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;nn_string_ix&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># above, near_neighbor_nn_string_ix is indices</span>
        <span class="c1"># match these indices to the string they correspond to in nn_strings_this_index</span>
        <span class="c1"># (and its commonness_penalty)</span>
        <span class="n">nn_string_info_mini</span> <span class="o">=</span> <span class="n">nn_string_info_this_index</span><span class="p">[[</span><span class="s1">&#39;nn_string&#39;</span><span class="p">,</span> <span class="s1">&#39;commonness_penalty&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">nn_string_info_mini</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nn_string_2&#39;</span><span class="p">,</span> <span class="s1">&#39;commonness_penalty_2&#39;</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">nn_string_info_mini</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;near_neighbor_nn_string_ix&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;nn_string_ix&#39;</span><span class="p">,</span> <span class="s1">&#39;nn_string_1&#39;</span><span class="p">,</span> <span class="s1">&#39;nn_string_2&#39;</span><span class="p">,</span> <span class="s1">&#39;cos_dist&#39;</span><span class="p">,</span> <span class="s1">&#39;commonness_penalty_1&#39;</span><span class="p">,</span> <span class="s1">&#39;commonness_penalty_2&#39;</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="Block.get_exact_match_candidate_pairs"><a class="viewcode-back" href="../../api.html#namematch.block.Block.get_exact_match_candidate_pairs">[docs]</a>    <span class="k">def</span> <span class="nf">get_exact_match_candidate_pairs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nn_string_info_multi</span><span class="p">,</span> <span class="n">nn_string_expanded_df</span><span class="p">,</span> <span class="n">blocking_thresholds</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;All nn_strings that appear more than once need to have a corresponding</span>
<span class="sd">        nn_string, nn_string candidate pair -- we can skip the &quot;approximation&quot; easily</span>
<span class="sd">        for this type of candidate pair.</span>

<span class="sd">        Args:</span>
<span class="sd">            nn_string_info_multi (pd.DataFrame): nn_string_info, subset to nn_strings with n_new &gt; 0 &amp; n_total &gt; 1</span>
<span class="sd">            nn_string_expanded_df (pd.DataFrame): table at nn_string/ed_string/absval_string level (expanded if split_name is True)</span>
<span class="sd">            blocking_thresholds (dict):  dictionary with thresholds for blocking, e.g. high and low bar</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: portion of the candidate pairs list (where nn_string_1 == nn_string_2)</span>

<span class="sd">            ==================   ==============================================================</span>
<span class="sd">            nn_string            concatenated version of nn-blocking columns (sep by ::)</span>
<span class="sd">            commonness_penalty   float indicating how common the last name is</span>
<span class="sd">            n_new                number of times this nn_string appears in a &quot;new&quot; record</span>
<span class="sd">            n_existing           number of times this nn_string appears in an &quot;existing&quot; record</span>
<span class="sd">            n_total              number of times this nn_string appears in any record</span>
<span class="sd">            ==================   ==============================================================</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Getting identical candidate pairs.&#39;</span><span class="p">)</span>

        <span class="c1"># adding (nnsX, nnsX) as a candidate if there are 2+ record for bsX</span>
        <span class="c1"># and 1+ come from &quot;new&quot;; second part of condition is already met</span>
        <span class="c1"># given that this df has just &quot;to query&quot; names)</span>

        <span class="n">nn_string_info_multi</span> <span class="o">=</span> <span class="n">nn_string_info_multi</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># identical first and last names</span>
        <span class="n">exact_match_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;nn_string_1&#39;</span> <span class="p">:</span> <span class="n">nn_string_info_multi</span><span class="o">.</span><span class="n">nn_string</span><span class="p">,</span>
            <span class="s1">&#39;nn_string_2&#39;</span> <span class="p">:</span> <span class="n">nn_string_info_multi</span><span class="o">.</span><span class="n">nn_string</span><span class="p">,</span>
            <span class="s1">&#39;cos_dist&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;commonness_penalty_1&#39;</span> <span class="p">:</span> <span class="n">nn_string_info_multi</span><span class="o">.</span><span class="n">commonness_penalty</span><span class="p">,</span>
            <span class="s1">&#39;commonness_penalty_2&#39;</span> <span class="p">:</span> <span class="n">nn_string_info_multi</span><span class="o">.</span><span class="n">commonness_penalty</span>
        <span class="p">})</span>

        <span class="n">exact_match_cp_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_blocking_filter</span><span class="p">(</span><span class="n">exact_match_df</span><span class="p">,</span> <span class="n">blocking_thresholds</span><span class="p">,</span>
                <span class="n">nn_string_expanded_df</span><span class="p">,</span> <span class="n">nns_match</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">exact_match_cp_df</span></div></div>


<div class="viewcode-block" id="get_blocking_columns"><a class="viewcode-back" href="../../api.html#namematch.block.get_blocking_columns">[docs]</a><span class="k">def</span> <span class="nf">get_blocking_columns</span><span class="p">(</span><span class="n">blocking_scheme</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get the list of blocking variables for each type of blocking:</span>

<span class="sd">    Args:</span>
<span class="sd">        blocking_scheme (dict): dictionary with info on how to do blocking</span>

<span class="sd">    Returns:</span>
<span class="sd">        list of string list: the variable names needed for each type of blocking</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">nn_cols</span> <span class="o">=</span> <span class="n">blocking_scheme</span><span class="p">[</span><span class="s1">&#39;cosine_distance&#39;</span><span class="p">][</span><span class="s1">&#39;variables&#39;</span><span class="p">]</span>
    <span class="n">ed_col</span> <span class="o">=</span> <span class="n">blocking_scheme</span><span class="p">[</span><span class="s1">&#39;edit_distance&#39;</span><span class="p">][</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">absval_col</span> <span class="o">=</span> <span class="n">blocking_scheme</span><span class="p">[</span><span class="s1">&#39;absvalue_distance&#39;</span><span class="p">][</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">absval_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="n">cols_to_read</span> <span class="o">=</span> <span class="n">nn_cols</span> <span class="o">+</span> <span class="p">[</span><span class="n">ed_col</span><span class="p">,</span> <span class="n">absval_col</span><span class="p">,</span> <span class="s1">&#39;file_type&#39;</span><span class="p">,</span> <span class="s1">&#39;drop_from_nm&#39;</span><span class="p">,</span> <span class="s1">&#39;record_id&#39;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Absvalue filter used as backup to edit_distance filter.&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">absval_col</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cols_to_read</span> <span class="o">=</span> <span class="n">nn_cols</span> <span class="o">+</span> <span class="p">[</span><span class="n">ed_col</span><span class="p">,</span> <span class="s1">&#39;file_type&#39;</span><span class="p">,</span> <span class="s1">&#39;drop_from_nm&#39;</span><span class="p">,</span> <span class="s1">&#39;record_id&#39;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;No backup to edit_distance filter being used.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nn_cols</span><span class="p">,</span> <span class="n">ed_col</span><span class="p">,</span> <span class="n">absval_col</span></div>


<div class="viewcode-block" id="read_an"><a class="viewcode-back" href="../../api.html#namematch.block.read_an">[docs]</a><span class="k">def</span> <span class="nf">read_an</span><span class="p">(</span><span class="n">an_file</span><span class="p">,</span> <span class="n">nn_cols</span><span class="p">,</span> <span class="n">ed_col</span><span class="p">,</span> <span class="n">absval_col</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Read in relevant columns for blocking from the all-names file.</span>

<span class="sd">    Args:</span>
<span class="sd">        an_file (str): path to the all-names file</span>
<span class="sd">        nn_cols (list of strings): variables for near neighbor blocking</span>
<span class="sd">        ed_col (list of strings): variables for edit-distance blocking</span>
<span class="sd">        absval_col (list of strings): variables for absolute-value blocking</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: all-names dataframe, relevant columns only (where drop_from_nm == 0)</span>

<span class="sd">        =======================   =======================================================</span>
<span class="sd">        record_id                 unique record identifier</span>
<span class="sd">        blockstring               concatenation of all the blocking variables (sep by ::)</span>
<span class="sd">        file_type                 either &quot;new&quot; or &quot;existing&quot;</span>
<span class="sd">        drop_from_nm              flag, 1 if met any &quot;to drop&quot; criteria 0 otherwise</span>
<span class="sd">        &lt;nn-blocking column(s)&gt;   variables for near-neighbor blocking</span>
<span class="sd">        &lt;ed-blocking column&gt;      variable for edit-distance blocking</span>
<span class="sd">        &lt;av-blocking column&gt;      (optional) variable for abs-value blocking</span>
<span class="sd">        nn_string                 concatenated version of nm-blocking columns (sep by ::)</span>
<span class="sd">        ed_string                 copy of ed-blocking column</span>
<span class="sd">        absval_string             copy of ed-blocking column</span>
<span class="sd">        =======================   =======================================================</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">cols_to_read</span> <span class="o">=</span> <span class="n">nn_cols</span> <span class="o">+</span> <span class="p">[</span><span class="n">ed_col</span><span class="p">,</span> \
            <span class="s1">&#39;blockstring&#39;</span><span class="p">,</span> <span class="s1">&#39;file_type&#39;</span><span class="p">,</span> <span class="s1">&#39;drop_from_nm&#39;</span><span class="p">,</span> <span class="s1">&#39;record_id&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">absval_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cols_to_read</span> <span class="o">=</span> <span class="n">nn_cols</span> <span class="o">+</span> <span class="p">[</span><span class="n">ed_col</span><span class="p">,</span> <span class="n">absval_col</span><span class="p">,</span> \
                <span class="s1">&#39;blockstring&#39;</span><span class="p">,</span> <span class="s1">&#39;file_type&#39;</span><span class="p">,</span> <span class="s1">&#39;drop_from_nm&#39;</span><span class="p">,</span> <span class="s1">&#39;record_id&#39;</span><span class="p">]</span>

    <span class="n">table</span> <span class="o">=</span> <span class="n">pq</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">an_file</span><span class="p">)</span>
    <span class="n">an</span> <span class="o">=</span>  <span class="n">table</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">absval_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">absval_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">an</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The </span><span class="si">{</span><span class="n">absval_col</span><span class="si">}</span><span class="s1"> variable was not found, and is needed for the chosen blocking scheme.&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="n">an</span> <span class="o">=</span> <span class="n">an</span><span class="p">[</span><span class="n">cols_to_read</span><span class="p">]</span>

    <span class="n">an</span> <span class="o">=</span> <span class="n">an</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">an</span> <span class="o">=</span> <span class="n">an</span><span class="p">[</span><span class="n">an</span><span class="o">.</span><span class="n">drop_from_nm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">an</span><span class="p">[</span><span class="s1">&#39;nn_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">get_nn_string_from_blockstring</span><span class="p">,</span>
                                   <span class="n">otypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">])(</span><span class="n">an</span><span class="o">.</span><span class="n">blockstring</span><span class="p">)</span>
    <span class="n">an</span><span class="p">[</span><span class="s1">&#39;ed_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">an</span><span class="p">[</span><span class="n">ed_col</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">absval_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">an</span><span class="p">[</span><span class="s1">&#39;absval_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">an</span><span class="p">[</span><span class="n">absval_col</span><span class="p">]</span>
        <span class="n">an</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">an</span><span class="o">.</span><span class="n">absval_string</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;absval_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
        <span class="n">an</span><span class="p">[</span><span class="s1">&#39;absval_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">an</span><span class="o">.</span><span class="n">absval_string</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">an</span></div>


<div class="viewcode-block" id="get_nn_string_counts"><a class="viewcode-back" href="../../api.html#namematch.block.get_nn_string_counts">[docs]</a><span class="k">def</span> <span class="nf">get_nn_string_counts</span><span class="p">(</span><span class="n">an</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Count number of records per nn_strings (per file_type).</span>

<span class="sd">    Args:</span>
<span class="sd">        an (pd.DataFrame): all-names table, relevant columns only (where drop_from_nm == 0)</span>

<span class="sd">            =======================  =======================================================</span>
<span class="sd">            record_id                unique record identifier</span>
<span class="sd">            blockstring              concatenation of all the blocking variables (sep by ::)</span>
<span class="sd">            file_type                either &quot;new&quot; or &quot;existing&quot;</span>
<span class="sd">            drop_from_nm             flag, 1 if met any &quot;to drop&quot; criteria 0 otherwise</span>
<span class="sd">            &lt;nn-blocking column(s)&gt;  variables for near-neighbor blocking</span>
<span class="sd">            &lt;ed-blocking column&gt;     variable for edit-distance blocking</span>
<span class="sd">            &lt;av-blocking column&gt;     (optional) variable for abs-value blocking</span>
<span class="sd">            nn_string                concatenated version of nm-blocking columns (sep by ::)</span>
<span class="sd">            ed_string                copy of ed-blocking column</span>
<span class="sd">            absval_string            copy of ed-blocking column</span>
<span class="sd">            =======================  =======================================================</span>

<span class="sd">    Return:</span>
<span class="sd">        dict: two keys (new and existing), mapping to a dictionary of nn_strings to n_records</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">an</span> <span class="o">=</span> <span class="n">an</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Counting nn_strings.&#39;</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">an</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;file_type&#39;</span><span class="p">,</span> <span class="s1">&#39;nn_string&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="s1">&#39;nn_string&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;file_type&#39;</span><span class="p">)</span>
    <span class="n">temp</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">droplevel</span><span class="p">()</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">nn_strings_to_num_recs</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;dict&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;existing&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nn_strings_to_num_recs</span><span class="p">:</span>
        <span class="n">nn_strings_to_num_recs</span><span class="p">[</span><span class="s1">&#39;existing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nn_strings_to_num_recs</span></div>


<div class="viewcode-block" id="get_common_name_penalties"><a class="viewcode-back" href="../../api.html#namematch.block.get_common_name_penalties">[docs]</a><span class="k">def</span> <span class="nf">get_common_name_penalties</span><span class="p">(</span><span class="n">clean_last_names</span><span class="p">,</span> <span class="n">max_penalty</span><span class="p">,</span> <span class="n">num_threshold_bins</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create a dictionary mapping each last name to a &quot;commonness penalty.&quot; Two SMITHs are</span>
<span class="sd">    less likely to be the same person than two HANDAs, since SMITH is such a common name. This</span>
<span class="sd">    function quantifies this penalty for use in later blocking calculations. A more common name</span>
<span class="sd">    recieves a higher number, topping out at max_penalty.</span>

<span class="sd">    Args:</span>
<span class="sd">        clean_last_names (pd.Series): clean (un-split) last name column (one row per record)</span>
<span class="sd">        max_penalty (float): the maximum penalty (for the most common names)</span>
<span class="sd">        num_threshold_bins (int): number of different categories of commonnness to create</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: dictionary mapping name (str) to penalty (float)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Getting last names frequencies.&#39;</span><span class="p">)</span>
    <span class="n">last_name_freq_df</span> <span class="o">=</span> <span class="n">clean_last_names</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">clean_last_names</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="n">last_name_freq_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;last_name&#39;</span>
    <span class="n">last_name_freq_df</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;ln_count&#39;</span>
    <span class="n">last_name_freq_df</span> <span class="o">=</span> <span class="n">last_name_freq_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="n">commonness_penalty_lookup</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">last_name_freq_df</span><span class="p">[</span><span class="s1">&#39;norm_ln_count&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">last_name_freq_df</span><span class="o">.</span><span class="n">ln_count</span> <span class="o">/</span> <span class="n">last_name_freq_df</span><span class="o">.</span><span class="n">ln_count</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">last_name_freq_df</span> <span class="o">=</span> <span class="n">last_name_freq_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;norm_ln_count&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">last_name_freq_df</span><span class="p">[</span><span class="s1">&#39;bin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span>
            <span class="n">last_name_freq_df</span><span class="o">.</span><span class="n">norm_ln_count</span><span class="p">,</span>
            <span class="n">num_threshold_bins</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">duplicates</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">)</span>
    <span class="n">threshold_bins</span> <span class="o">=</span> <span class="n">last_name_freq_df</span><span class="p">[</span><span class="s1">&#39;bin&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">threshold_levels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;bin&#39;</span> <span class="p">:</span> <span class="n">threshold_bins</span><span class="p">,</span>
            <span class="s1">&#39;threshold&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">max_penalty</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">threshold_bins</span><span class="p">))})</span>
    <span class="n">last_name_freq_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">last_name_freq_df</span><span class="p">,</span> <span class="n">threshold_levels</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;bin&#39;</span><span class="p">)</span>
    <span class="n">last_name_freq_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;last_name&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">commonness_penalty_lookup</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">max_penalty</span><span class="p">,</span> <span class="n">last_name_freq_df</span><span class="o">.</span><span class="n">threshold</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">commonness_penalty_lookup</span></div>


<div class="viewcode-block" id="get_all_shingles"><a class="viewcode-back" href="../../api.html#namematch.block.get_all_shingles">[docs]</a><span class="k">def</span> <span class="nf">get_all_shingles</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Get all valid 2-shingles.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: valid 2-shingles</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">valid_characters</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="s1">&#39; *&#39;</span>
    <span class="n">all_tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">valid_characters</span><span class="p">,</span><span class="n">valid_characters</span><span class="p">))</span>
    <span class="n">all_two_shingles</span> <span class="o">=</span> <span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">all_tuples</span><span class="p">]</span>
    <span class="n">valid_two_shingles</span> <span class="o">=</span> <span class="p">[</span><span class="n">sh</span> <span class="k">for</span> <span class="n">sh</span> <span class="ow">in</span> <span class="n">all_two_shingles</span> <span class="k">if</span> <span class="n">sh</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39;* &#39;</span><span class="p">,</span> <span class="s1">&#39; *&#39;</span><span class="p">]]</span>
    <span class="c1"># NOTE: leave ** in case we ever allow blank nn_strings</span>

    <span class="k">return</span> <span class="n">valid_two_shingles</span></div>


<div class="viewcode-block" id="prep_index"><a class="viewcode-back" href="../../api.html#namematch.block.prep_index">[docs]</a><span class="k">def</span> <span class="nf">prep_index</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Initialize index data structure, which will store similarity information</span>
<span class="sd">    about the names, and load processed shingles into it.</span>

<span class="sd">    Returns:</span>
<span class="sd">        nnmslib.FloatIndex: nmslib index object (pre time-consuming build call)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># intialize index</span>
    <span class="n">space_type</span> <span class="o">=</span> <span class="s1">&#39;cosinesimil_sparse&#39;</span>
    <span class="n">space_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">method_name</span> <span class="o">=</span> <span class="s1">&#39;hnsw&#39;</span>

    <span class="n">ix</span> <span class="o">=</span> <span class="n">nmslib</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
        <span class="n">space</span><span class="o">=</span><span class="n">space_type</span><span class="p">,</span>
        <span class="n">space_params</span><span class="o">=</span><span class="n">space_params</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="n">method_name</span><span class="p">,</span>
        <span class="n">data_type</span><span class="o">=</span><span class="n">nmslib</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">SPARSE_VECTOR</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">nmslib</span><span class="o">.</span><span class="n">DistType</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ix</span></div>


<div class="viewcode-block" id="get_second_index_nn_strings"><a class="viewcode-back" href="../../api.html#namematch.block.get_second_index_nn_strings">[docs]</a><span class="k">def</span> <span class="nf">get_second_index_nn_strings</span><span class="p">(</span><span class="n">all_nn_strings</span><span class="p">,</span> <span class="n">main_nn_strings</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get nn_strings that haven&#39;t already been stored in the main index.</span>

<span class="sd">    Args:</span>
<span class="sd">        all_nn_strings (list): list of all nn_strings in the data (expanded if split_names is True)</span>
<span class="sd">        main_nn_strings (list): list of nn_strings already in the main index</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: the nn_strings that are not in main_nn_strings</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">all_nn_strings</span> <span class="o">=</span> <span class="n">all_nn_strings</span><span class="p">[:]</span>
    <span class="n">main_nn_strings</span> <span class="o">=</span> <span class="n">main_nn_strings</span><span class="p">[:]</span>

    <span class="n">all_nn_strings_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">all_nn_strings</span><span class="p">)</span>
    <span class="n">second_index_nn_strings</span> <span class="o">=</span> <span class="n">all_nn_strings_s</span><span class="p">[</span>
            <span class="n">all_nn_strings_s</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">main_nn_strings</span><span class="p">))</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">second_index_nn_strings</span></div>


<div class="viewcode-block" id="save_main_index"><a class="viewcode-back" href="../../api.html#namematch.block.save_main_index">[docs]</a><span class="k">def</span> <span class="nf">save_main_index</span><span class="p">(</span><span class="n">main_index</span><span class="p">,</span> <span class="n">main_index_nn_strings</span><span class="p">,</span> <span class="n">main_index_file</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Save the main nmslib index and pickle dump the associated nn_strings list.</span>

<span class="sd">    Args:</span>
<span class="sd">        main_index (nmslib.FloatIndex): the main, built nmslib index</span>
<span class="sd">        main_index_nn_strings (list): list of nn_strings in the main index</span>
<span class="sd">        main_index_file (str): path to store the main nmslib index</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">main_index</span><span class="o">.</span><span class="n">saveIndex</span><span class="p">(</span><span class="n">main_index_file</span><span class="p">,</span> <span class="n">save_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">main_index_file</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pf</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">main_index_nn_strings</span><span class="p">,</span> <span class="n">pf</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_main_index_nn_strings"><a class="viewcode-back" href="../../api.html#namematch.block.load_main_index_nn_strings">[docs]</a><span class="k">def</span> <span class="nf">load_main_index_nn_strings</span><span class="p">(</span><span class="n">og_blocking_index_file</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Load the nn_strings that are in an existing nmslbi index file.</span>

<span class="sd">    Args:</span>
<span class="sd">        og_blocking_index_file (str): path to original blocking index</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: loaded list of nn_strings in an existing nmslib index</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">og_blocking_index_file</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">main_index_nn_strings</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">main_index_nn_strings</span></div>


<div class="viewcode-block" id="write_some_cps"><a class="viewcode-back" href="../../api.html#namematch.block.write_some_cps">[docs]</a><span class="k">def</span> <span class="nf">write_some_cps</span><span class="p">(</span><span class="n">cand_pairs</span><span class="p">,</span> <span class="n">candidate_pairs_file</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Write out a portion of the candidate-pairs.</span>

<span class="sd">    Args:</span>
<span class="sd">        cand_pairs (pd.DataFrame): chunk of the candidate-pairs file</span>
<span class="sd">        candidate_pairs_file (str): path to the candidate-pairs file</span>
<span class="sd">        header (bool): True if this is the first time calling this function</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">cand_pairs</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
            <span class="n">candidate_pairs_file</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span>
            <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_NONNUMERIC</span><span class="p">)</span></div>


<div class="viewcode-block" id="generate_true_pairs"><a class="viewcode-back" href="../../api.html#namematch.block.generate_true_pairs">[docs]</a><span class="k">def</span> <span class="nf">generate_true_pairs</span><span class="p">(</span><span class="n">must_links_df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reduce the must-link records pairs must-link blockstring pairs.</span>

<span class="sd">    Args:</span>
<span class="sd">        must_links_df (pd.DataFrame): list of must-link record pairs</span>

<span class="sd">            ===================   =======================================================</span>
<span class="sd">            record_id_1           unique identifier for the first record in the pair</span>
<span class="sd">            record_id_2           unique identifier for the second record in the pair</span>
<span class="sd">            blockstring_1         blockstring for the first record in the pair</span>
<span class="sd">            blockstring_2         blockstring for the second record in the pair</span>
<span class="sd">            drop_from_nm_1        flag, 1 if the first record in the pair was not eligible for matching</span>
<span class="sd">            drop_from_nm_2        flag, 1 if the second record in the pair was not eligible for matching</span>
<span class="sd">            existing              flag, 1 if the pair is must-link because of ExistingID</span>
<span class="sd">            ===================   =======================================================</span>

<span class="sd">    Return:</span>
<span class="sd">        pd.DataFrame: list of must-link blockstring pairs (where both record have drop_from_nm == 0)</span>

<span class="sd">        ===================   =======================================================</span>
<span class="sd">        blockstring_1         blockstring for the first record in the pair</span>
<span class="sd">        blockstring_2         blockstring for the second record in the pair</span>
<span class="sd">        ===================   =======================================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">must_links_df</span> <span class="o">=</span> <span class="n">must_links_df</span><span class="p">[(</span><span class="n">must_links_df</span><span class="o">.</span><span class="n">drop_from_nm_1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                                  <span class="p">(</span><span class="n">must_links_df</span><span class="o">.</span><span class="n">drop_from_nm_2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>

    <span class="n">true_pairs_df</span> <span class="o">=</span> <span class="n">must_links_df</span><span class="p">[[</span><span class="s1">&#39;blockstring_1&#39;</span><span class="p">,</span> <span class="s1">&#39;blockstring_2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">true_pairs_df</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Melissa McNeill, Eddie Lin, Zubin Jelveh.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>